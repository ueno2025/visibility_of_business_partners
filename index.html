<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主要取引先可視化ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        #chartContainer {
            width: 90%;
            max-width: 800px;
            height: auto;
            margin: auto;
        }

        #myChart {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>

<body>
    <h1>主要取引先 確認ツール</h1>
    <label for="codeInput">証券コードか企業名を入力:</label>
    <input type="text" id="codeInput" placeholder="例: 1381,アクシーズ">
    <button onclick="searchCompany()">検索</button>
    <p id="result"></p>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let jsonData = [];
        let chart = null; // グラフを保持する変数

        // JSONを読み込み
        fetch("data.json")
            .then(response => response.json())
            .then(data => {
                jsonData = data;
                checkUrlParam(); // ページ読み込み時に ?code= をチェック
            })
            .catch(error => console.error("読み込み失敗:", error));

        // --- URLパラメータを確認して検索 ---
        function checkUrlParam() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            if (code) {
                document.getElementById("codeInput").value = code;
                searchCompany();
            }
        }

        function searchCompany() {
            const keyword = document.getElementById("codeInput").value.trim();
            document.getElementById("codeInput").value = "";
            if (chart) chart.destroy();

            // 検索結果をURLに反映
            if (keyword) {
                const newUrl = `${window.location.pathname}?code=${encodeURIComponent(keyword)}`;
                history.pushState(null, "", newUrl);
            }

            // 証券コード完全一致を優先
            let exactMatch = jsonData.find(item => item["証券コード"] === keyword);

            if (exactMatch) {
                showCompanyDetail(exactMatch);
                return;
            }

            // 部分一致（証券コード or 企業名）
            let matches = jsonData.filter(item =>
                String(item["証券コード"] || "").includes(keyword) ||
                String(item["企業名"] || "").includes(keyword)
            );

            let resultDiv = document.getElementById("result");

            if (matches.length === 0) {
                resultDiv.textContent = `${keyword}: 該当する証券コードまたは企業名は見つかりませんでした。`;
            } else if (matches.length === 1) {
                // 1件なら詳細表示
                showCompanyDetail(matches[0]);
            } else {
                // 複数件なら候補一覧を表示
                let html = `<p>「${keyword}」に一致する候補:</p><ul>`;
                matches.forEach(m => {
                    html += `<li>${m["証券コード"]} - ${m["企業名"]} (${m["業種"]}) 
                            <button onclick="showCompanyDetailByCode('${m["証券コード"]}')">確認</button></li>`;
                });
                html += "</ul>";
                resultDiv.innerHTML = html;
            }
        }

        // 証券コードで再検索して詳細を表示
        function showCompanyDetailByCode(code) {
            const company = jsonData.find(item => item["証券コード"] === code);
            if (company) {
                showCompanyDetail(company);
            }
        }

        // 詳細情報＋円グラフを表示
        function showCompanyDetail(result) {
            if (chart) chart.destroy();
            let html = `証券コード: ${result["証券コード"]} <br> 企業名: ${result["企業名"]} <br> 業種: ${result["業種"]}`;
            const map_url = "https://ueno2025.github.io/company_address/?code=" + result["証券コード"];
            const map_url = "https://ueno2025.github.io/reverse_cliants/?code=" + result["証券コード"];
            html += `<br> <a href="${map_url}" target="_blank">所在地の場所を検索</a>`;
            html += `<br> <a href="${map_url}" target="_blank">${result["企業名"]}への主要取引先を検索</a>`;

            if (result["主要取引先"].length > 0) {
                html += "<h3>主要取引先</h3><ul>";
                result["主要取引先"].forEach(client => {
                    html += `<li>${client["取引先名"]} - 金額: ${client["金額"]}&nbsp;&nbsp;&nbsp;割合: ${client["割合"]}%</li>`;
                });
                html += "</ul>";
            } else {
                html += "<p>主要取引先は登録されていません。</p>";
            }

            document.getElementById("result").innerHTML = html;

            // 主要取引先から割合が "-" のものを除外
            let validClients = result["主要取引先"].filter(c => {
                return c["割合"] !== "-" && c["割合"] !== "－" && !isNaN(parseFloat(c["割合"]));
            });

            let labels = validClients.map(c => c["取引先名"]);
            let data = validClients.map(c => parseFloat(c["割合"]));
            const ctx = document.getElementById("myChart").getContext("2d");

            // --- 主要取引先が空の場合は「その他100%」 ---
            if (data.length === 0) {
                labels = ["その他"];
                data = [100];
            } else {
                // 合計チェック
                const total = data.reduce((a, b) => a + b, 0);
                if (total < 100) {
                    labels.push("その他");
                    data.push(100 - total);
                }
            }

            let baseColors = [
                "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF",
                "#FF9F40", "#8AC926", "#1982C4", "#6A4C93", "#FF595E"
            ];
            const backgroundColors = labels.map((l, i) => {
                if (l === "その他") return "#C9CBCF";
                return baseColors[i % baseColors.length];
            });

            chart = new Chart(ctx, {
                type: "pie",
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        datalabels: {
                            formatter: (value) => value.toFixed(1) + '%',
                            color: "#000",
                            font: { weight: "bold", size: 12 }
                        },
                        legend: { position: "right" }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Enterキーでも検索できるようにする
        document.getElementById("codeInput").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                searchCompany();
            }
        });
    </script>
</body>
</html>
